{% extends "base.html" %}

{% block title %}Merge Packages - S4LT{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Merge Packages</h1>

<div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
    <h2 class="text-xl font-bold mb-4">Select Packages</h2>

    <div id="package-list" class="space-y-2 mb-4">
        <div class="flex gap-2">
            <input type="text" name="path" placeholder="Package path..."
                   class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded">
            <button onclick="addPackageInput()" class="px-4 py-2 bg-blue-600 rounded">+</button>
        </div>
    </div>

    <div class="flex gap-4">
        <input type="text" id="output-path" placeholder="Output path..."
               class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded">
        <button onclick="checkConflicts()" class="px-4 py-2 bg-yellow-600 rounded">
            Check Conflicts
        </button>
    </div>
</div>

<div id="conflicts-section" class="hidden bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
    <h2 class="text-xl font-bold mb-4">Conflicts</h2>
    <div id="conflicts-list"></div>
</div>

<button onclick="executeMerge()" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded font-bold">
    Merge Packages
</button>

<script>
function addPackageInput() {
    const list = document.getElementById('package-list');
    const div = document.createElement('div');
    div.className = 'flex gap-2';
    div.innerHTML = `
        <input type="text" name="path" placeholder="Package path..."
               class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded">
        <button onclick="this.parentElement.remove()" class="px-4 py-2 bg-red-600 rounded">-</button>
    `;
    list.appendChild(div);
}

async function checkConflicts() {
    const inputs = document.querySelectorAll('input[name="path"]');
    const paths = Array.from(inputs).map(i => i.value).filter(p => p);

    const formData = new FormData();
    paths.forEach(p => formData.append('paths', p));

    const response = await fetch('/package/merge/check', {
        method: 'POST',
        body: formData
    });
    const data = await response.json();

    const section = document.getElementById('conflicts-section');
    const list = document.getElementById('conflicts-list');

    if (data.conflicts && data.conflicts.length > 0) {
        section.classList.remove('hidden');
        list.innerHTML = data.conflicts.map(c => `
            <div class="p-2 bg-gray-700 rounded mb-2">
                <div class="font-mono text-sm">${c.tgi}</div>
                <div class="text-gray-400 text-sm">Found in: ${c.sources.map(s => s[0]).join(', ')}</div>
            </div>
        `).join('');
    } else {
        section.classList.add('hidden');
    }
}

async function executeMerge() {
    const inputs = document.querySelectorAll('input[name="path"]');
    const paths = Array.from(inputs).map(i => i.value).filter(p => p);
    const output = document.getElementById('output-path').value;

    const formData = new FormData();
    paths.forEach(p => formData.append('paths', p));
    formData.append('output', output);

    const response = await fetch('/package/merge/execute', {
        method: 'POST',
        body: formData
    });
    const data = await response.json();

    if (data.status === 'merged') {
        alert('Packages merged successfully!');
    }
}
</script>
{% endblock %}
